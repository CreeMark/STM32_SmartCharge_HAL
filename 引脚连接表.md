# STM32F103工程模块引脚连接表

> **项目名称**：环境监测系统  
> **MCU型号**：STM32F103  
> **开发框架**：HAL库  
> **文档生成日期**：2025-10-21

---

## 1. 显示模块

### 1.1 1.8寸ST7735S LCD显示屏（SPI接口）

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **SCK（时钟）** | PA5 | SPI1_SCK | 推挽输出 | 与W25Q128共用SPI1总线 |
| **MOSI（数据输出）** | PA7 | SPI1_MOSI | 推挽输出 | 与W25Q128共用SPI1总线 |
| **RES（复位）** | PB0 | GPIO输出 | 推挽输出 | 低电平复位 |
| **DC（数据/命令）** | PB1 | GPIO输出 | 推挽输出 | 低=命令，高=数据 |
| **CS（片选）** | PB10 | GPIO输出 | 推挽输出 | 低电平有效 |
| **BLK（背光）** | PB11 | GPIO输出 | 推挽输出 | 高电平点亮 |

---

## 2. 存储设备

### 2.1 W25Q128 SPI Flash存储芯片

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **CLK（时钟）** | PA5 | SPI1_SCK | 推挽输出 | 与LCD共用SPI1总线 |
| **MISO（数据输入）** | PA6 | SPI1_MISO | 浮空输入 | Flash→MCU |
| **MOSI（数据输出）** | PA7 | SPI1_MOSI | 推挽输出 | 与LCD共用 |
| **CS（片选）** | PC13 | GPIO输出 | 推挽输出 | 低电平有效 |

---

## 3. 执行设备

### 3.1 2路继电器模块（低电平触发）

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **IN1（继电器1控制）** | PC1 | GPIO输出 | 推挽输出 | 低电平=吸合，高电平=断开 |
| **IN2（继电器2控制）** | PC2 | GPIO输出 | 推挽输出 | 低电平=吸合，高电平=断开 |
| **VCC** | - | - | - | 接5V电源（继电器模块供电） |
| **GND** | - | - | - | 接GND |

**继电器1负载接线（控制PWM风扇）**：
- **COM端**：接5V电源正极
- **NO端（常开）**：接PWM风扇VCC
- **NC端（常闭）**：不接
- **风扇GND**：接GND
- **风扇PWM引脚**：悬空或接VCC（全速运行）

**继电器2负载接线**：
- **COM端**：接负载电源正极
- **NO端（常开）**：接负载正极
- **NC端（常闭）**：根据需求选择

---

### 3.2 ~~XPT2046电阻触摸屏（已停用）~~

> **状态**：触摸屏功能已移除，PC0-PC4引脚已重新分配  
> **原因**：新LCD屏幕无触摸功能，释放引脚用于继电器控制  

| 原功能 | 原引脚 | 新用途 | 备注 |
|--------|--------|--------|------|
| ~~XPT2046_IRQ~~ | ~~PC1~~ | RELAY_IN1 | 继电器1控制 |
| ~~XPT2046_MISO~~ | ~~PC2~~ | RELAY_IN2 | 继电器2控制 |
| ~~XPT2046_CLK~~ | ~~PC0~~ | 空闲 | 可用于扩展 |
| ~~XPT2046_MOSI~~ | ~~PC3~~ | 空闲 | 可用于扩展 |
| ~~XPT2046_CS~~ | ~~PC4~~ | 空闲 | 可用于扩展 |

---

## 4. 环境传感器

### 4.1 DHT11温湿度传感器（单总线）

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **DATA（数据）** | PB4 | GPIO双向 | 开漏输出 | 单总线，3脚模块内置上拉，需禁用JTAG |

> **引脚变更说明**：DHT11数据引脚已从PD2更改为PB4  
> **原因**：PD2与UART5存在冲突，改用PB4（原JTAG-TRST引脚）  
> **注意**：PB4原为JTAG调试引脚，使用前需通过`__HAL_AFIO_REMAP_SWJ_NOJTAG()`禁用JTAG功能

---

### 4.2 HC-SR501人体红外感应模块

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **OUT（输出）** | PC12 | GPIO输入 | 上拉输入 | 高电平=检测到人体 |

---

### 4.3 光敏电阻传感器（双输出）

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **DO（数字输出）** | PB15 | GPIO输入 | 上拉输入 | 高=亮，低=暗 |
| **AO（模拟输出）** | PA2 | ADC1_IN2 | 模拟输入 | 0-3.3V电压信号 |

---

## 5. 人机交互

### 5.1 按键输入（2个独立按键）

| 按键 | STM32引脚 | 中断线 | 触发方式 | 电气特性 | 备注 |
|------|----------|-------|---------|---------|------|
| **KEY_1_WKUP** | PA0 | EXTI0 | 上升沿触发 | 下拉输入 | 按下=高电平 |
| **KEY_2** | PA1 | EXTI1 | 下降沿触发 | 上拉输入 | 按下=低电平 |
| ~~**KEY_3**~~ | ~~PA4~~ | ~~EXTI4~~ | ~~已停用~~ | ~~上拉输入~~ | ~~引脚已用作继电器~~ |

---

### 5.2 LED指示灯

| LED | STM32引脚 | 引脚说明 | 控制逻辑 | 备注 |
|-----|----------|---------|---------|------|
| **LED_RED** | PC5 | GPIO输出 | 低电平点亮 | 红色LED |
| **LED_BLUE** | PB2 | GPIO输出 | 低电平点亮 | 蓝色LED |

---

## 6. 通信接口

### 6.1 CAN总线通信

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **CAN_RX** | PB8 | CAN1_RX | 浮空输入 | 接收端 |
| **CAN_TX** | PB9 | CAN1_TX | 推挽复用 | 发送端 |

---

### 6.2 ESP8266 Wi-Fi模块（UART通信）

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **TX** | PA9 | USART1_TX | 推挽复用 | MCU发送→ESP8266接收 |
| **RX** | PA10 | USART1_RX | 浮空输入 | MCU接收←ESP8266发送 |

---

### 6.3 HLW8032电能计量模块（UART通信）

| 功能 | STM32引脚 | 引脚说明 | 电气特性 | 备注 |
|------|----------|---------|---------|------|
| **TX** | PC11 | USART3_RX | 上拉输入 | HLW8032发送→MCU接收，4800bps |
| **PF（功率脉冲）** | PA8 | GPIO输入 | 上拉输入 | 50%占空比方波，功率校验 |
| **RE（继电器控制）** | PA4 | GPIO输出 | 推挽输出 | 需外接三极管驱动电路 |
| **VCC** | - | - | - | 接5V电源 |
| **GND** | - | - | - | 接GND（与MCU共地） |

**RE引脚驱动电路说明**：
- **PA4** → 10kΩ电阻 → NPN三极管（SS8050）基极
- 三极管发射极接GND
- 三极管集电极 → 继电器线圈一端
- 继电器线圈另一端接5V
- 线圈两端并联1N4148续流二极管（阴极接5V端）

---

## 7. 引脚占用统计

### 7.1 按端口分类

| GPIO端口 | 已用引脚数 | 主要功能 | 详细引脚列表 |
|---------|----------|---------|-------------|
| **GPIOA** | 11个 | SPI1、ADC、UART、按键、HLW8032 | PA0, PA1, PA2, PA4, PA5, PA6, PA7, PA8, PA9, PA10, PA11 |
| **GPIOB** | 9个 | LCD控制、LED、CAN、传感器 | PB0, PB1, PB2, PB8, PB9, PB10, PB11, PB15 |
| **GPIOC** | 6个 | 继电器、Flash CS、LED、传感器、UART3 | PC1, PC2, PC5, PC10, PC11, PC12, PC13 |
| **GPIOD** | 1个 | DHT11数据线 | PD2 |

---

## 8. 快速查询表（按引脚排序）

| 引脚 | 功能 | 外设 | 配置 |
|------|------|------|------|
| PA0 | KEY_1_WKUP | 按键1 | 下拉输入+EXTI0 |
| PA1 | KEY_2 | 按键2 | 上拉输入+EXTI1 |
| PA2 | LIGHT_SENSOR_AO | 光敏传感器AO | ADC1_IN2 |
| PA4 | HLW8032_RE | HLW8032继电器控制 | 推挽输出 |
| PA5 | SPI1_SCK | LCD+Flash时钟 | 推挽复用 |
| PA6 | SPI1_MISO | Flash数据输入 | 浮空输入 |
| PA7 | SPI1_MOSI | LCD+Flash数据 | 推挽复用 |
| PA8 | HLW8032_PF | HLW8032功率脉冲 | 上拉输入 |
| PA9 | USART1_TX | ESP8266 TX | 推挽复用 |
| PA10 | USART1_RX | ESP8266 RX | 浮空输入 |
| PB0 | LCD_RES | LCD复位 | 推挽输出 |
| PB1 | LCD_DC | LCD数据/命令 | 推挽输出 |
| PB2 | LED_BLUE | 蓝色LED | 推挽输出 |
| PB8 | CAN1_RX | CAN接收 | 浮空输入 |
| PB9 | CAN1_TX | CAN发送 | 推挽复用 |
| PB10 | LCD_CS | LCD片选 | 推挽输出 |
| PB11 | LCD_BLK | LCD背光 | 推挽输出 |
| PB15 | LIGHT_SENSOR_DO | 光敏传感器DO | 上拉输入 |
| PC1 | RELAY_IN1 | 继电器1控制 | 推挽输出（初始高电平） |
| PC2 | RELAY_IN2 | 继电器2控制 | 推挽输出（初始高电平） |
| PC5 | LED_RED | 红色LED | 推挽输出 |
| PC10 | USART3_TX | HLW8032通信（预留） | 推挽复用 |
| PC11 | USART3_RX | HLW8032接收 | 上拉输入 |
| PC12 | SR501_IN | 人体感应 | 上拉输入 |
| PC13 | W25Q128_CS | Flash片选 | 推挽输出 |
| PD2 | DHT11_DATA | 温湿度传感器 | 开漏输出 |

---

## 9. 重要注意事项

### 9.1 SPI总线复用
- LCD和W25Q128共用SPI1（PA5/PA7）
- 通过独立CS信号区分设备
- 操作前确保另一设备CS为高电平

### 9.2 调试接口
- 已禁用JTAG（保留SWD）
- 释放PB3/PB4/PD2作为普通GPIO
- 代码中已添加：`__HAL_AFIO_REMAP_SWJ_NOJTAG()`

### 9.3 传感器要求
- **DHT11**：GPIO必须配置为开漏输出，3脚模块内置上拉
- **HC-SR501**：预热时间约1分钟
- **光敏传感器**：同时提供数字和模拟输出

### 9.4 电源注意
- 所有外设均使用3.3V供电逻辑
- ESP8266需大电流（建议独立供电）
- 每个芯片电源引脚附近放置100nF去耦电容

### 9.5 继电器控制
- **继电器模块**：采用低电平触发，PC1/PC2输出低电平时继电器吸合
- **初始状态**：上电时PC1/PC2为高电平，继电器断开，避免误触发
- **继电器1功能**：自动控制PWM风扇，光照<20%时开启风扇
- **继电器2功能**：保留扩展接口，可控制其他负载（如灯具、加热器等）
- **负载电压**：继电器可承受最大AC 250V/10A或DC 30V/10A
- **隔离保护**：继电器模块内置光耦隔离，保护MCU电路

### 9.6 HLW8032电能计量模块
- **通信协议**：USART3，波特率4800bps，n-8-1格式
- **数据帧**：每50ms发送24字节，包含电压、电流、功率、功率因数、电能等
- **PF引脚**：输出50%占空比方波，脉冲频率与有功功率正相关，用于交叉校验
- **RE引脚**：继电器控制信号输出，需通过NPN三极管（SS8050）放大电流后驱动继电器
- **电源要求**：5V供电，与MCU共地，确保串口通信稳定性
- **续流二极管**：继电器线圈两端并联1N4148，防止反向电动势损坏元件

---

**文档结束**
